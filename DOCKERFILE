# Copyright (C) 2026 darkfiber-lab

# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU Affero General Public License as published
# by the Free Software Foundation, version 3.

# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
# See the GNU Affero General Public License for more details.

# You should have received a copy of the GNU Affero General Public License
# along with this program. If not, see <https://www.gnu.org/licenses/>.

# QuietRoom Server Dockerfile
# Runtime-only container - expects pre-compiled binary
# Base: Alpine Linux (MIT License) - minimal, secure
# Host OS: Oracle Linux 8 (container runs Alpine regardless)

FROM alpine:3.19

# Install minimal runtime dependencies
RUN apk --no-cache add \
    ca-certificates \
    tzdata \
    bash

# Create non-root user matching typical host UID/GID
# Using 1000:1000 which is common for first non-root user on Oracle Linux
RUN addgroup -g 1000 quietroom && \
    adduser -D -u 1000 -G quietroom quietroom

# Set working directory
WORKDIR /app

# Copy pre-compiled binary into container
# This binary should be built before creating the Docker image
COPY quietroom_server /app/quietroom_server

# Make binary executable and set ownership
RUN chmod +x /app/quietroom_server && \
    chown quietroom:quietroom /app/quietroom_server

# Ensure proper ownership of /app directory
RUN chown -R quietroom:quietroom /app

# Switch to non-root user
USER quietroom

# Expose default port
EXPOSE 37842

# Health check using nc (netcat) which is in busybox
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD nc -z localhost 37842 || exit 1

# Expected volume mount:
# /app - single directory containing everything:
#   - quietroom_server (binary is already in container, but can be overridden by mount)
#   - server_config.json (config file)
#   - server_private.pem, chat_public.pem (generated by server)
#   - chat_server.log, security.log (generated by server)
VOLUME ["/app"]

# Run the server
CMD ["./quietroom_server"]